# Build System Documentation

This directory contains documentation for the Video Looper build system configuration.

## Quick Start

### Build the Project

```bash
./scripts/build.sh
```

This automatically:
1. Sets up PKG_CONFIG_PATH for framework discovery
2. Configures the Meson build system
3. Compiles the project using Ninja

### Validate Dependencies

```bash
./scripts/pkgconfig_setup.sh
```

This verifies all required dependencies are discoverable and displays version information.

## Documentation Files

### PKG_CONFIG_SETUP.md
Comprehensive guide to pkg-config configuration including:
- Overview of the problem and solution
- Custom .pc file format
- Configuration methods (automatic and manual)
- Verification procedures
- Troubleshooting guide
- Best practices and references

**When to read:** If you're experiencing build issues or want to understand how dependency resolution works.

### PKG_CONFIG_IMPLEMENTATION.md
Technical implementation details of Task T-1.2:
- What was implemented
- Files created and modified
- Validation results
- How the dependency discovery flow works
- Compliance with SDD §5
- Related tasks and next steps

**When to read:** If you want to understand what was done in Task T-1.2 or need to modify the configuration.

## Build System Structure

```
Video Looper Project Root
├── meson.build                     # Main Meson build configuration
├── meson_options.txt               # Build options
│
├── scripts/
│   ├── build.sh                    # Primary build script (uses pkg-config)
│   ├── pkgconfig_setup.sh          # Validates pkg-config configuration
│   ├── run.sh                      # Run script
│   ├── test.sh                     # Test runner
│   └── format_code.sh              # Code formatter
│
├── pkgconfig/                      # Custom pkg-config framework definitions
│   ├── Cocoa.pc                    # Cocoa framework definition
│   ├── AVFoundation.pc             # AVFoundation framework definition
│   ├── CoreFoundation.pc           # CoreFoundation framework definition
│   ├── CoreMedia.pc                # CoreMedia framework definition
│   ├── CoreVideo.pc                # CoreVideo framework definition
│   └── README.md                   # Framework documentation
│
├── build/                          # Generated by Meson (build artifacts)
│   ├── meson-private/              # Meson internal files
│   ├── video-looper               # Compiled executable
│   └── [build output files]
│
└── docs/build/                     # This directory
    ├── README.md                   # This file
    ├── PKG_CONFIG_SETUP.md         # Setup guide
    └── PKG_CONFIG_IMPLEMENTATION.md # Task T-1.2 implementation details
```

## Key Dependencies

### GStreamer (System Package)
- **Version:** >= 1.20
- **Discovery:** System pkg-config
- **Install:** `brew install gstreamer gstreamer-plugins-base`

### macOS Frameworks (Custom .pc Files)
- **Cocoa:** Window management and UI
- **AVFoundation:** Camera access and media capture
- **CoreFoundation:** System utilities
- **CoreMedia:** Media data handling
- **CoreVideo:** GPU video frame management

All macOS framework definitions are in `pkgconfig/` with proper version specifications.

## Build Commands

### Standard Build
```bash
./scripts/build.sh
```

### Debug Build
```bash
./scripts/build.sh --debug
```

### Clean Rebuild
```bash
./scripts/build.sh --clean
```

### Verbose Output
```bash
./scripts/build.sh --verbose
```

### Combine Options
```bash
./scripts/build.sh --clean --debug --verbose
```

## Troubleshooting

### Build Fails with "Dependency not found"

1. **Check PKG_CONFIG_PATH:**
   ```bash
   echo $PKG_CONFIG_PATH
   ```
   Should include the project's `pkgconfig/` directory.

2. **Run validation script:**
   ```bash
   ./scripts/pkgconfig_setup.sh
   ```

3. **Verify .pc files exist:**
   ```bash
   ls -la pkgconfig/*.pc
   ```

### GStreamer Not Found

```bash
# Install GStreamer
brew install gstreamer gstreamer-plugins-base

# Verify installation
pkg-config --modversion gstreamer-1.0
```

### Framework Version Mismatch

Update to macOS 15.7+ or check:
```bash
sw_vers
```

### Permission Errors

Ensure write access to build directory:
```bash
rm -rf build
./scripts/build.sh
```

## Configuration Details

### Meson Configuration

The `meson.build` file:
1. Detects the host system (requires macOS/Darwin)
2. Discovers GStreamer and GLib via system pkg-config
3. Discovers Cocoa and AVFoundation via custom .pc files in `pkgconfig/`
4. Configures compiler and linker flags
5. Builds the video-looper executable

### pkg-config Path Resolution

When building:
1. `build.sh` sets `PKG_CONFIG_PATH="$PWD/pkgconfig:$PKG_CONFIG_PATH"`
2. Meson calls `pkg-config` to discover each dependency
3. pkg-config first searches `pkgconfig/` (custom frameworks)
4. Then searches system paths (GStreamer, GLib, etc.)
5. Returns compiler flags and library paths to Meson

### Framework Include Paths

When compiling with all dependencies, the compiler receives:
- GStreamer include paths (from system pkg-config)
- GLib include paths (from system pkg-config)
- Cocoa framework headers (from pkgconfig/Cocoa.pc)
- AVFoundation framework headers (from pkgconfig/AVFoundation.pc)
- CoreFoundation, CoreMedia, CoreVideo headers (from respective .pc files)

All automatically resolved through the pkg-config dependency chain.

## Environment Variables

### PKG_CONFIG_PATH
Set by `build.sh` automatically. Can be manually set:
```bash
export PKG_CONFIG_PATH="$(pwd)/pkgconfig:$PKG_CONFIG_PATH"
```

### Other Build Variables
Set by Meson based on `meson_options.txt`:
- `buildtype`: release (default) or debug
- `warning_level`: 3 (default, strict warnings)
- `c_std`: c11 (for GStreamer 1.20+ compatibility)

## Next Steps

After successful build:

1. **Run the executable:**
   ```bash
   ./build/video-looper
   ```

2. **Run tests:**
   ```bash
   ./scripts/test.sh
   ```

3. **Format code:**
   ```bash
   ./scripts/format_code.sh
   ```

## Development Workflow

### Standard Development Build
```bash
# Clean, debug build with verbose output
./scripts/build.sh --clean --debug --verbose

# Or use shorter form
./scripts/build.sh -c -d -v
```

### After Making Changes
```bash
# Quick incremental rebuild
./scripts/build.sh

# Run tests to verify
./scripts/test.sh
```

### Before Committing
```bash
# Clean release build with no warnings
./scripts/build.sh --clean --release

# Run all tests
./scripts/test.sh

# Format code
./scripts/format_code.sh
```

## Reference Documentation

- [Meson Build System](https://mesonbuild.com/)
- [pkg-config Manual](https://pkg-config.freedesktop.org/)
- [GStreamer Documentation](https://gstreamer.freedesktop.org/)
- [macOS Frameworks](https://developer.apple.com/documentation/)

## Support

For detailed information on pkg-config configuration, see:
- **PKG_CONFIG_SETUP.md** - Setup guide and troubleshooting
- **PKG_CONFIG_IMPLEMENTATION.md** - Technical implementation details

For project structure and source organization, see:
- **PROJECT_STRUCTURE.md** - Directory organization
- **docs/planning/SDD.md** - Software Design Document

---

**Last Updated:** January 27, 2026
**Version:** 1.0
**Status:** Complete
